<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Temp Mail — Simple Viewer</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;max-width:800px;color:#222;background:#fafafa}
  h1{font-size:1.6rem;margin-bottom:0}
  header{margin-bottom:1rem}
  .card{background:#fff;border:1px solid #ddd;padding:16px;border-radius:10px;margin-top:12px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
  button,select,input{font:inherit;padding:8px 12px;border-radius:6px;border:1px solid #ccc}
  button{cursor:pointer;background:#0069ed;color:#fff;border:none}
  button:hover{background:#0053ba}
  .emails{max-height:320px;overflow:auto;margin-top:8px;border-radius:6px;padding:8px;background:#f9f9f9;border:1px solid #eee}
  .mono{font-family:ui-monospace,Menlo,Monaco,"Roboto Mono",monospace}
  small.note{color:#666}
  pre{background:#f7f7f7;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>Temp Mail Viewer</h1>
  <small class="note">Uses public APIs (mail.tm & 1secmail). Works on GitHub Pages.</small>
</header>

<section class="card">
  <h2>Temporary Email</h2>
  <label>Choose provider:
    <select id="emailProvider">
      <option value="mailtm">mail.tm (recommended)</option>
      <option value="1secmail">1secmail</option>
    </select>
  </label>
  <br>
  <label>Local part (optional):
    <input id="localpart" placeholder="example: tester123" />
  </label>
  <br>
  <button id="createEmail">Create temp email</button>
  <div id="emailInfo" style="margin-top:10px"></div>

  <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
    <button id="fetchEmails">Fetch Inbox</button>
    <button id="autoPoll">Start auto-refresh (5s)</button>
    <button id="stopPoll" disabled>Stop</button>
    <button id="deleteMail" style="margin-left:auto;background:#d9534f">Delete account</button>
  </div>

  <div class="emails" id="emailsList" aria-live="polite"></div>
</section>

<section class="card">
  <h2>Notes</h2>
  <ul>
    <li><strong>mail.tm</strong> creates a real temporary mailbox with login & password.</li>
    <li><strong>1secmail</strong> offers instant inbox without registration.</li>
    <li>If messages don’t load, the provider API may block browser CORS temporarily — try switching provider.</li>
    <li>Use for testing only — don’t store personal data.</li>
  </ul>
</section>

<script>
const byId=id=>document.getElementById(id);
const emailsList=byId('emailsList');
const emailInfo=byId('emailInfo');
let pollHandle=null;
let currentAccount=null;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

async function mailtmCreate(localPart){
  const domainsRes=await fetch('https://api.mail.tm/domains');
  if(!domainsRes.ok)throw new Error('mail.tm domain fetch failed');
  const domainsData=await domainsRes.json();
  const domain=domainsData['hydra:member']?.[0]?.domain||'mail.tm';
  const username=localPart||('user'+Math.floor(Math.random()*1e6));
  const address=`${username}@${domain}`;
  const password='P@ss'+Math.random().toString(36).slice(2,10);
  const createRes=await fetch('https://api.mail.tm/accounts',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({address,password})
  });
  if(!createRes.ok)throw new Error(await createRes.text());
  const account=await createRes.json();
  const tokenRes=await fetch('https://api.mail.tm/token',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({address,password})
  });
  if(!tokenRes.ok)throw new Error('mail.tm auth failed');
  const token=await tokenRes.json();
  return {address,password,id:account.id,token:token.token};
}

async function mailtmFetchMessages(token){
  const res=await fetch('https://api.mail.tm/messages',{headers:{Authorization:'Bearer '+token}});
  if(!res.ok)throw new Error('mail.tm fetch messages failed');
  const data=await res.json();
  return data['hydra:member']||[];
}
async function mailtmGetMessage(token,id){
  const res=await fetch(`https://api.mail.tm/messages/${id}`,{headers:{Authorization:'Bearer '+token}});
  return res.ok?res.json():null;
}
async function mailtmDeleteAccount(id,token){
  return fetch(`https://api.mail.tm/accounts/${id}`,{method:'DELETE',headers:{Authorization:'Bearer '+token}});
}

async function oneSecCreate(localPart){
  if(localPart){
    const domains=['1secmail.com','1secmail.org','1secmail.net','wwjmp.com','esiix.com'];
    const domain=domains[Math.floor(Math.random()*domains.length)];
    return {address:`${localPart}@${domain}`};
  }else{
    const res=await fetch('https://www.1secmail.com/api/v1/?action=genRandomMailbox&count=1');
    const arr=await res.json();
    return {address:arr[0]};
  }
}
async function oneSecListMessages(address){
  const [login,domain]=address.split('@');
  const res=await fetch(`https://www.1secmail.com/api/v1/?action=getMessages&login=${encodeURIComponent(login)}&domain=${encodeURIComponent(domain)}`);
  return res.ok?res.json():[];
}
async function oneSecGetMessage(address,id){
  const [login,domain]=address.split('@');
  const res=await fetch(`https://www.1secmail.com/api/v1/?action=readMessage&login=${encodeURIComponent(login)}&domain=${encodeURIComponent(domain)}&id=${id}`);
  return res.ok?res.json():null;
}

byId('createEmail').addEventListener('click',async()=>{
  const provider=byId('emailProvider').value;
  const local=byId('localpart').value.trim()||null;
  try{
    emailInfo.textContent='Creating...';
    if(provider==='mailtm'){
      const acc=await mailtmCreate(local);
      currentAccount={provider:'mailtm',address:acc.address,id:acc.id,token:acc.token};
      emailInfo.innerHTML=`<div><strong>${acc.address}</strong></div><div class="small">Password: <span class="mono">${acc.password}</span></div>`;
    }else{
      const acc=await oneSecCreate(local);
      currentAccount={provider:'1secmail',address:acc.address};
      emailInfo.innerHTML=`<div><strong>${acc.address}</strong></div>`;
    }
    emailsList.innerHTML='';
  }catch(e){
    emailInfo.textContent='Error: '+e.message;
  }
});

byId('fetchEmails').addEventListener('click',fetchAndRenderEmails);
byId('autoPoll').addEventListener('click',()=>{
  if(!currentAccount)return alert('Create an email first');
  byId('autoPoll').disabled=true;
  byId('stopPoll').disabled=false;
  pollHandle=setInterval(fetchAndRenderEmails,5000);
});
byId('stopPoll').addEventListener('click',()=>{
  clearInterval(pollHandle);pollHandle=null;
  byId('autoPoll').disabled=false;
  byId('stopPoll').disabled=true;
});
byId('deleteMail').addEventListener('click',async()=>{
  if(!currentAccount||currentAccount.provider!=='mailtm')return alert('Only mail.tm accounts can be deleted.');
  try{
    await mailtmDeleteAccount(currentAccount.id,currentAccount.token);
    alert('Account deleted.');
    currentAccount=null;
    emailInfo.innerHTML='';
    emailsList.innerHTML='';
  }catch(e){alert('Delete failed: '+e.message);}
});

async function fetchAndRenderEmails(){
  if(!currentAccount)return alert('Create an email first');
  emailsList.textContent='Fetching...';
  try{
    let messages=[];
    if(currentAccount.provider==='mailtm'){
      messages=await mailtmFetchMessages(currentAccount.token);
      const full=await Promise.all(messages.map(m=>mailtmGetMessage(currentAccount.token,m.id)));
      renderEmailList(full.map(m=>({id:m.id,from:m.from?.address||m.from,subject:m.subject,intro:m.intro||m.text?.slice(0,180),html:m.html,text:m.text})));
    }else{
      messages=await oneSecListMessages(currentAccount.address);
      const full=await Promise.all(messages.map(m=>oneSecGetMessage(currentAccount.address,m.id)));
      renderEmailList(full.map(m=>({id:m.id,from:m.from,subject:m.subject,intro:m.text?.slice(0,180),html:m.html,text:m.text})));
    }
  }catch(e){
    emailsList.textContent='Error fetching: '+e.message;
  }
}

function renderEmailList(items){
  if(!items||items.length===0){emailsList.innerHTML='<div><em>No messages yet.</em></div>';return;}
  emailsList.innerHTML='';
  for(const it of items){
    const wrap=document.createElement('div');
    wrap.style.borderBottom='1px solid #eee';wrap.style.padding='8px 0';
    wrap.innerHTML=`<strong>${escapeHtml(it.subject||'(no subject)')}</strong>
      <div style="font-size:0.9em;color:#555">From: ${escapeHtml(it.from||'')}</div>
      <div>${escapeHtml(it.intro||'')}</div>`;
    const btn=document.createElement('button');
    btn.textContent='Open';
    btn.style.marginTop='6px';
    btn.addEventListener('click',()=>{
      const dialog=window.open('','_blank','width=800,height=600');
      dialog.document.write(`<h2>${escapeHtml(it.subject||'')}</h2><div>From: ${escapeHtml(it.from||'')}</div><hr>`);
      if(it.html)dialog.document.write(it.html);
      else dialog.document.write('<pre>'+escapeHtml(it.text||'')+'</pre>');
    });
    wrap.appendChild(btn);
    emailsList.appendChild(wrap);
  }
}

function escapeHtml(s){return s?s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])):'';}
</script>
</body>
</html>
